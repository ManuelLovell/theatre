import{O as n,C as l,L as i,G as d}from"./bsSceneCache-C_5PpwJt.js";async function g(s,e){try{const t=window.location.origin.includes("localhost")?"eternaldream":"",o={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:l.ANONAUTH,"x-manuel":t}),body:JSON.stringify(e)},a=await fetch(s,o),r=await a.json();if(!a.ok)await n.notification.show("There was an error retrieving your data, please refresh the page. If this issue persists, wait a few minutes as the server could be experiencing difficulties."),console.error("Error:",r);else return r}catch(t){return await n.notification.show("There was an error retrieving your data, please refresh the page. If this issue persists, wait a few minutes as the server could be experiencing difficulties."),console.error("Error:",t),null}}async function u(){const s={owlbearid:n.player.id,requesttype:"READ"},e=await g(l.REMOTESTORAGEURL,s);return e.Error!==!0&&e.Data!==""&&e.Data!==null&&e.Data!==void 0?JSON.parse(e.Data):[]}async function c(s){const e={owlbearid:n.player.id,requesttype:"CREATE",data:s},t=await g(l.REMOTESTORAGEURL,e);if(t.Error!==!0&&t.Data!==""&&t.Data!==null&&t.Data!==void 0)return!0}async function D(s){const e={owlbearid:n.player.id,requesttype:"UPDATE",data:JSON.stringify(s)},t=await g(l.REMOTESTORAGEURL,e);if(t.Error!==!0&&t.Data!==""&&t.Data!==null&&t.Data!==void 0)return!0}async function f(s){const e={owlbearid:n.player.id,requesttype:"DELETE",data:s},t=await g(l.REMOTESTORAGEURL,e);if(t.Data!==""&&t.Data!==null&&t.Data!==void 0)return!0}class m{isUserRegistered;dialogues=[];constructor(e){this.isUserRegistered=e}async migrateLocalToRemote(e){i.log("[Storage] Migrating",e.length,"local dialogues to remote storage");const t=e.map(a=>({...a,theatre_id:d()})),o=await c(JSON.stringify(t));if(i.log("[Storage] Migration result:",o),o)for(const a of e)this.deleteLocalDialogue(a.id)}loadLocalDialogues(){const e=localStorage.getItem(l.STORAGEKEY);return e?JSON.parse(e).map(t=>({...t,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt)})):[]}async loadRemoteDialogues(){i.log("[Storage] Loading dialogues from remote storage");const e=await u();return e&&Array.isArray(e)?(i.log("[Storage] Loaded",e.length,"dialogues from remote"),e.map(t=>({...JSON.parse(t.save_data),createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt)}))):(i.log("[Storage] No remote dialogues found"),[])}mergeDialogues(e,t){const o=new Map;return e.forEach(a=>{o.set(a.id,a)}),t.forEach(a=>{const r=o.get(a.id);(!r||new Date(a.updatedAt)>new Date(r.updatedAt))&&o.set(a.id,a)}),Array.from(o.values()).sort((a,r)=>new Date(r.updatedAt).getTime()-new Date(a.updatedAt).getTime())}saveLocalDialogues(e){localStorage.setItem(l.STORAGEKEY,JSON.stringify(e))}async saveRemoteDialogue(e){i.log("[Storage] Saving dialogue to remote:",e.id,e.title),e.theatre_id=e.id,await D(e),i.log("[Storage] Dialogue saved to remote successfully")}deleteLocalDialogue(e){const o=this.loadLocalDialogues().filter(a=>a.id!==e);this.saveLocalDialogues(o)}async deleteRemoteDialogue(e){i.log("[Storage] Deleting dialogue from remote:",e),await f(e),i.log("[Storage] Dialogue deleted from remote successfully")}async loadDialogues(){if(this.isUserRegistered){i.log("[Storage] Loading dialogues for registered user (local + remote)");const[e,t]=await Promise.all([Promise.resolve(this.loadLocalDialogues()),this.loadRemoteDialogues()]);this.dialogues=this.mergeDialogues(e,t),i.log("[Storage] Merged dialogues count:",this.dialogues.length),e.length>0&&await this.migrateLocalToRemote(e)}else i.log("[Storage] Loading dialogues for non-registered user (local only)"),this.dialogues=this.loadLocalDialogues(),i.log("[Storage] Loaded",this.dialogues.length,"local dialogues")}async saveDialogues(e){if(this.isUserRegistered){const t=this.dialogues.find(o=>o.id===e);t&&await this.saveRemoteDialogue(t)}else this.saveLocalDialogues(this.dialogues)}async deleteDialogue(e){const t=this.dialogues.find(o=>o.id===e);this.dialogues=this.dialogues.filter(o=>o.id!==e),this.isUserRegistered?t&&t.theatre_id&&this.deleteRemoteDialogue(t.theatre_id):this.saveLocalDialogues(this.dialogues)}}export{m as DialogueStorageManager};
