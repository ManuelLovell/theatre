import{O as a,C as n,b as F,a as P,c as g}from"./bsConstants-Cmf1ZMgY.js";function $(c){return c.type==="IMAGE"}function Q(){const c=document.createElement("img");return c.id="whatsNewButton",c.style.cursor="pointer",c.setAttribute("class","icon"),c.classList.add("clickable"),c.setAttribute("title","Whats New?"),c.setAttribute("src","/w-info.svg"),c.onclick=async function(){await a.modal.open({id:n.EXTENSIONWHATSNEW,url:`/submenu/whatsnew.html?subscriber=${p.USER_REGISTERED}`,height:500,width:350})},c}function B(c,e){if(c.length!==e.length)return!1;for(let t=0;t<c.length;t++)if(c[t]!==e[t])return!1;return!0}function U(){let c=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const l=(c+Math.random()*16)%16|0;return c=Math.floor(c/16),(t==="x"?l:l&3|8).toString(16)})}function L(c,e){let t;return function(){clearTimeout(t),t=setTimeout(()=>{c()},e)}}function X(c,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),l=t.matches?"dark":"light",s=t.matches?"light":"dark";for(var r=0;r<e.styleSheets.length;r++)for(var i=0;i<e.styleSheets[r].cssRules.length;i++){let d=e.styleSheets[r].cssRules[i];d&&d.media&&d.media.mediaText.includes("prefers-color-scheme")&&(c.mode=="LIGHT"?(d.media.appendMedium(`(prefers-color-scheme: ${l})`),d.media.mediaText.includes(s)&&d.media.deleteMedium(`(prefers-color-scheme: ${s})`)):c.mode=="DARK"&&(d.media.appendMedium(`(prefers-color-scheme: ${s})`),d.media.mediaText.includes(l)&&d.media.deleteMedium(`(prefers-color-scheme: ${l})`)))}}function q(c,e){return Math.abs(c.x-e.x)+Math.abs(c.y-e.y)}function K(c,e,t){return q(c,e)<=t}class V{mainWindow=document.getElementById("app");controlToggle=document.getElementById("viewControls");controlPanel=document.getElementById("controlPanel");historyToggle=document.getElementById("viewHistory");historyPanel=document.getElementById("historyPanel");sendButton=document.getElementById("sendMessage");whatsNew=document.getElementById("whatsNewContainer");characterSelectLabel=document.getElementById("characterLabel");characterSelect=document.getElementById("CharacterSelect");playerSelect=document.getElementById("PlayerSelect");playerSelectHolder=document.getElementById("playerSelectHolder");overrideNameInput=document.getElementById("OverrideName");messageTextarea=document.getElementById("MessageTextarea");messageTypeSelect=document.getElementById("MessageType");viewMessageBox=document.getElementById("ViewMessage");whisperDistance=document.getElementById("whisperDistance");talkDistance=document.getElementById("talkDistance");yellDistance=document.getElementById("yellDistance");messageRange=document.getElementById("messageRange");messageRangeHolder=document.getElementById("rangeSelectHolder");broadcaster=new BroadcastChannel(n.SELFCHANNEL);version;constructor(e){this.version=`THEATRE-${e}`,this.whatsNew?.appendChild(Q())}async StartThreatre(){this.SetupButtons(),this.SetupItemSelect(),this.UpdatePlayerSelect()}SetupButtons(){this.messageRangeHolder.style.display="none",this.playerSelectHolder.style.display="flex",this.messageTypeSelect.onchange=()=>{this.messageTypeSelect.value==="bubble"?(this.messageRangeHolder.style.display="flex",this.playerSelectHolder.style.display="none"):(this.messageRangeHolder.style.display="none",this.playerSelectHolder.style.display="flex")},this.controlToggle.onclick=e=>{e.preventDefault(),this.controlPanel.style.display="block",this.controlToggle.classList.add("selected"),this.historyPanel.style.display="none",this.historyToggle.classList.remove("selected")},this.historyToggle.onclick=e=>{e.preventDefault(),this.controlPanel.style.display="none",this.controlToggle.classList.remove("selected"),this.historyPanel.style.display="block",this.historyToggle.classList.add("selected")},this.sendButton.onclick=async e=>{e.preventDefault(),await this.SendMessage()},p.playerRole==="GM"?(this.talkDistance.onblur=async()=>{await a.scene.setMetadata({[`${n.EXTENSIONID}/talk`]:this.talkDistance.value})},this.whisperDistance.onblur=async()=>{await a.scene.setMetadata({[`${n.EXTENSIONID}/whisper`]:this.whisperDistance.value})},this.yellDistance.onblur=async()=>{await a.scene.setMetadata({[`${n.EXTENSIONID}/yell`]:this.yellDistance.value})}):(this.talkDistance.disabled=!0,this.whisperDistance.disabled=!0,this.yellDistance.disabled=!0),this.talkDistance.value=p.sceneMetadata[`${n.EXTENSIONID}/talk`]??"5",this.whisperDistance.value=p.sceneMetadata[`${n.EXTENSIONID}/whisper`]??"1",this.yellDistance.value=p.sceneMetadata[`${n.EXTENSIONID}/yell`]??"10"}async SendMessage(){if(!this.messageTextarea.value.trim())return console.log("NO MESSAGE");const e=p.sceneItems.find(d=>d.id===this.characterSelect.value);if(!e||!e.image?.url)return console.log("NO IMAGE");const t=e.text?.plainText?e.text.plainText:e.name,l=U();let s=this.messageTextarea.value;switch(this.messageTextarea.value){case"fresh":s=n.FRESHPRINCE;break;case"test":s=n.MULTIPAGE;break}const r={Id:e.id,Name:this.overrideNameInput.value?this.overrideNameInput.value:t,ImageUrl:e.image.url,Message:s,TargetId:this.playerSelect.value,Type:this.messageTypeSelect.value,Code:l},i={[`${n.EXTENSIONID}/dialogueBox`]:r,[`${n.EXTENSIONID}/dialogueCode`]:l};if(this.messageTypeSelect.value==="bubble"){const d={Id:e.id,Name:this.overrideNameInput.value?this.overrideNameInput.value:t,Message:s,Range:this.messageRange.value},y={[`${n.EXTENSIONID}/bubbleBox`]:d};await a.broadcast.sendMessage(n.BROADCASTCHANNEL,y),this.viewMessageBox.checked&&this.broadcaster.postMessage(y)}else await a.broadcast.sendMessage(n.BROADCASTCHANNEL,i),this.viewMessageBox.checked?this.broadcaster.postMessage(i):await a.notification.show("Message sent","SUCCESS")}SetupItemSelect(){const e=document.getElementById("CharacterSelect");e.innerHTML="",p.sceneItems.forEach(t=>{if(t.layer==="CHARACTER"&&(t.createdUserId===p.playerId||p.playerRole==="GM")){const l=t,s=document.createElement("option");s.value=t.id,s.text=l.text?.plainText?l.text.plainText:t.name,e.add(s)}})}UpdatePlayerSelect(){const e=document.getElementById("PlayerSelect");let t=e.value;const l=document.createElement("option");l.setAttribute("value","0000");const s=document.createTextNode("Everyone");if(l.appendChild(s),e.innerHTML="",e.appendChild(l),p.party.forEach(i=>{let d=document.createElement("option");d.setAttribute("value",i.id);let y=document.createTextNode(i.name);d.appendChild(y),e.appendChild(d)}),!p.party.find(i=>i.id===t)&&t&&t!=="0000"){let i=document.createElement("option");i.setAttribute("value",t);let d=document.createTextNode("(Disconnected)");i.appendChild(d),e.appendChild(i),e.value=t,e.classList.add("glowing-text"),e.classList.add("glowing-text"),setTimeout(function(){e.classList.remove("glowing-text"),e.classList.remove("glowing-text")},5e3)}else t&&(e.value=t)}}const T=new V("2.0");class G{static async UpdateLabel(e,t,l,s,r){let i;switch(r){case"whisper":i="blue",s=s.toLowerCase();break;case"talk":i="lightgrey";break;case"yell":i="red",s=s.toUpperCase();break}const d=await a.scene.local.getItemAttachments([e.id]);for(const m of d)m.metadata[`${n.EXTENSIONID}/id`]&&await a.scene.local.deleteItems([m.id]);const y="#242424",w=parseInt(t),O=+l/100,M=400,h=F().fillColor("white").plainText(s).fillOpacity(1).strokeWidth(1.75).strokeColor("black").strokeOpacity(1).build(),b=U(),A={};A[`${n.EXTENSIONID}/id`]=b,h.position={x:e.position.x,y:e.position.y},h.attachedTo=e.id,h.visible=!!e.visible,h.locked=!0,h.disableAttachmentBehavior=["ROTATION","SCALE"],h.type="TEXT",h.metadata=A,h.zIndex=1,h.text.type="PLAIN",h.text.width=M,h.text.style.fontWeight=600,h.text.style.fontSize=w,h.text.style.textAlign="CENTER",h.text.style.fontFamily="Roboto",await a.scene.local.addItems([h]);const x=await a.scene.local.getItems(m=>m.metadata[`${n.EXTENSIONID}/id`]===b),I=await a.scene.local.getItemBounds(x.map(m=>m.id)),v=I.height+100;await a.scene.local.updateItems(m=>m.id===x[0].id,m=>{for(const u of m)u.position.y-=v});const R={min:{x:I.min.x,y:I.min.y-v},max:{x:I.max.x,y:I.max.y-v},center:{x:I.center.x,y:I.center.y-(I.height+50)},width:I.width,height:I.height},D=[],Y=W(R),C=P().commands(Y).strokeOpacity(1).strokeColor(i).fillOpacity(O).fillColor(y).zIndex(2).build();C.attachedTo=x[0].id,C.disableHit=!0,C.disableAttachmentBehavior=["ROTATION","SCALE"];const k=P().locked(!1).commands(n.CLOSEBUTTON).scale({x:.4,y:.4}).locked(!0).name("Close Button").metadata({[`${n.EXTENSIONID}/closeId`]:x[0].id}).position({x:R.min.x-15,y:R.min.y-15}).strokeColor("white").fillColor("#AA82E6").zIndex(3).build();k.attachedTo=x[0].id,D.push(C),D.push(k),await a.scene.local.addItems(D),setTimeout(async()=>{await a.scene.local.deleteItems(x.map(m=>m.id))},6e4);function W(m){const u=m.min.x-20,S=m.max.x+20,N=m.min.y-20,f=m.max.y+20,H=Math.abs(S-u),z=H/4,E=20;return[[g.MOVE,u+E,N],[g.QUAD,u,N,u,N+E],[g.LINE,u,f-E],[g.QUAD,u,f,u+E,f],[g.LINE,u+(H/2-z),f],[g.LINE,e.position.x,e.position.y],[g.LINE,S-H/2,f],[g.LINE,S-E,f],[g.QUAD,S,f,S,f-E],[g.LINE,S,N+E],[g.QUAD,S,N,S-E,N],[g.LINE,u+E,N],[g.CLOSE]]}}}class o{static PLAYER="PLAYER";static PARTY="PARTY";static LOCALITEMS="LOCALITEMS";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnLocalItemsChange;debouncedOnSceneMetadataChange;playerId;playerConnection;playerColor;playerName;playerMetadata;playerRole;party;lastParty;gridDpi;gridScale;localItems;oldSceneItems;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;caches;USER_REGISTERED;historyLog;sceneMetadataHandler;localItemsHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(e){this.playerId="",this.playerConnection="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.lastParty=[],this.sceneItems=[],this.oldSceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.USER_REGISTERED=!1,this.caches=e,this.historyLog={},this.debouncedOnSceneItemsChange=L(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=L(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnLocalItemsChange=L(this.OnLocalItemsChange.bind(this),100)}async InitializeCache(){this.sceneReady=await a.scene.isReady(),this.theme=await a.theme.getTheme(),X(this.theme,document),this.caches.includes(o.PLAYER)&&(this.playerId=await a.player.getId(),this.playerConnection=await a.player.getConnectionId(),this.playerName=await a.player.getName(),this.playerColor=await a.player.getColor(),this.playerMetadata=await a.player.getMetadata(),this.playerRole=await a.player.getRole()),this.caches.includes(o.PARTY)&&(this.party=await a.party.getPlayers()),this.caches.includes(o.LOCALITEMS)&&this.sceneReady&&(this.localItems=await a.scene.local.getItems()),this.caches.includes(o.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await a.scene.items.getItems()),this.caches.includes(o.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await a.scene.getMetadata()),this.caches.includes(o.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await a.scene.grid.getDpi(),this.gridScale=(await a.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(o.ROOMMETA)&&(this.roomMetadata=await a.room.getMetadata())}async HandleMessage(e){const t=e[`${n.EXTENSIONID}/dialogueCode`],l=e[`${n.EXTENSIONID}/dialogueBox`],s=e[`${n.EXTENSIONID}/bubbleBox`],r=l?.Type=="dialogue";if(s){const i=this.sceneItems.find(w=>w.id===s.Id),d={x:i.position.x/this.gridDpi,y:i.position.y/this.gridDpi};let y;switch(s.Range){case"whisper":y=this.sceneMetadata[`${n.EXTENSIONID}/whisper`]??1;break;case"talk":y=this.sceneMetadata[`${n.EXTENSIONID}/talk`]??5;break;case"yell":y=this.sceneMetadata[`${n.EXTENSIONID}/yell`]??10;break}if(i.createdUserId===this.playerId||this.playerRole==="GM")await G.UpdateLabel(i,"36","80",s.Message,s.Range),this.UpdateHistoryLog(e,!0);else{let w=!1;const O=this.sceneItems.filter(M=>M.createdUserId===this.playerId);for(const M of O){const h={x:M.position.x/this.gridDpi,y:M.position.y/this.gridDpi};K(d,h,y)&&(w=!0)}w&&(await G.UpdateLabel(i,"36","80",s.Message,s.Range),this.UpdateHistoryLog(e,!0))}}else if(l){if(l.TargetId!=="0000"&&l.TargetId!==this.playerId)return;await a.popover.close(n.EXTENSIONID);const i=await a.viewport.getWidth(),d=await a.viewport.getHeight();await a.player.setMetadata(e),r?await a.popover.open({id:n.EXTENSIONID,url:`/submenu/subindex.html?code=${t}`,height:200,width:i-100,hidePaper:!0,disableClickAway:!0,anchorPosition:{top:d-250,left:50},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"LEFT"},transformOrigin:{vertical:"CENTER",horizontal:"LEFT"}}):await a.popover.open({id:n.EXTENSIONID,url:`/submenu/subindex.html?code=${t}`,height:d/2,width:i/2,hidePaper:!0,disableClickAway:!0,anchorPosition:{top:d/4,left:i/4},transformOrigin:{vertical:"TOP",horizontal:"LEFT"},anchorReference:"POSITION",anchorOrigin:{vertical:"TOP",horizontal:"LEFT"}}),this.UpdateHistoryLog(e,!1)}}UpdateHistoryLog(e,t){const l=document.querySelector("#dialogLog");if(t){if(e[`${n.EXTENSIONID}/bubbleBox`]!=null){const s=e[`${n.EXTENSIONID}/bubbleBox`],r=document.createElement("li");r.innerHTML=`<div class="author">${s.Name}:</div>➤ ${s.Message.trim()}`,l.append(r)}}else if(e[`${n.EXTENSIONID}/dialogueBox`]!=null){const s=e[`${n.EXTENSIONID}/dialogueBox`],r=document.createElement("li");r.innerHTML=`<div class="author">${s.Name}:</div>➤ ${s.Message.trim()}`,l.append(r)}}OpenBroadcast(){const e=new BroadcastChannel(n.SELFCHANNEL);e.onmessage=async t=>{await this.HandleMessage(t.data)},a.broadcast.onMessage(n.BROADCASTCHANNEL,async t=>{await this.HandleMessage(t.data)})}KillHandlers(){this.caches.includes(o.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(o.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(o.SCENEITEMS)&&this.localItemsHandler!==void 0&&this.localItemsHandler(),this.caches.includes(o.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(o.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(o.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(o.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(o.SCENEMETA)&&(this.sceneMetadataHandler=a.scene.onMetadataChange(async e=>{this.sceneMetadata=e,this.debouncedOnSceneMetadataChange(e)})),(this.localItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(o.LOCALITEMS)&&(this.localItemsHandler=a.scene.local.onChange(async e=>{this.localItems=e,this.debouncedOnLocalItemsChange(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(o.SCENEITEMS)&&(this.sceneItemsHandler=a.scene.items.onChange(async e=>{const t=e.filter(l=>$(l));this.sceneItems=t,this.debouncedOnSceneItemsChange(t)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(o.SCENEGRID)&&(this.sceneGridHandler=a.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(o.PLAYER)&&(this.playerHandler=a.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerConnection=e.connectionId,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(o.PARTY)&&(this.partyHandler=a.party.onChange(async e=>{this.party=e.filter(t=>t.id!==""),await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(o.ROOMMETA)&&(this.roomHandler=a.room.onMetadataChange(async e=>{this.roomMetadata=e,await this.OnRoomMetadataChange(e)})),this.themeHandler===void 0&&(this.themeHandler=a.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=a.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await a.scene.items.getItems($),this.sceneMetadata=await a.scene.getMetadata(),this.gridDpi=await a.scene.grid.getDpi(),this.gridScale=(await a.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){if(this.playerRole!=="GM"){const t=this.sceneMetadata[`${n.EXTENSIONID}/talk`],l=this.sceneMetadata[`${n.EXTENSIONID}/whisper`],s=this.sceneMetadata[`${n.EXTENSIONID}/yell`];t&&(T.talkDistance.value=t),l&&(T.whisperDistance.value=l),s&&(T.yellDistance.value=s)}}async OnLocalItemsChange(e){}async OnSceneItemsChange(e){if(this.sceneReady){const t=this.sceneItems.map(i=>i.id),l=this.oldSceneItems.map(i=>i.id),s=this.sceneItems.map(i=>i.text.plainText?i.text.plainText:i.name),r=this.oldSceneItems.map(i=>i.text.plainText?i.text.plainText:i.name);if(B(t,l)&&B(s,r))return;T.SetupItemSelect(),this.oldSceneItems=this.sceneItems,T.characterSelectLabel.classList.add("glowing-text"),T.characterSelect.classList.add("glowing-text"),setTimeout(function(){T.characterSelectLabel.classList.remove("glowing-text"),T.characterSelect.classList.remove("glowing-text")},5e3)}}async OnSceneGridChange(e){}async OnSceneReadyChange(e){}async OnPlayerChange(e){if(e.selection?.length===1){const t=e.selection[0],l=this.localItems.find(s=>s.id===t&&s.metadata[`${n.EXTENSIONID}/closeId`]);l&&await a.scene.local.deleteItems([l.attachedTo])}}async OnPartyChange(e){T.UpdatePlayerSelect()}async OnRoomMetadataChange(e){}async OnThemeChange(e){X(e,document)}}const p=new o([o.PLAYER,o.PARTY,o.SCENEITEMS,o.SCENEMETA,o.LOCALITEMS,o.SCENEGRID]);export{p as B,X as S,T};
