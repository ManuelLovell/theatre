import{O as l,C as r,L as n,G as u}from"./bsSceneCache-Cf7b9lp_.js";async function d(s,e){try{const t=window.location.origin.includes("localhost")?"eternaldream":"",i={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:r.ANONAUTH,"x-manuel":t}),body:JSON.stringify(e)},a=await fetch(s,i),o=await a.json();if(!a.ok)await l.notification.show("There was an error retrieving your data, please refresh the page. If this issue persists, wait a few minutes as the server could be experiencing difficulties."),console.error("Error:",o);else return o}catch(t){return await l.notification.show("There was an error retrieving your data, please refresh the page. If this issue persists, wait a few minutes as the server could be experiencing difficulties."),console.error("Error:",t),null}}async function g(){const s={owlbearid:l.player.id,requesttype:"READ"},e=await d(r.REMOTESTORAGEURL,s);return e.Error!==!0&&e.Data!==""&&e.Data!==null&&e.Data!==void 0?JSON.parse(e.Data):[]}async function c(s){const e={owlbearid:l.player.id,requesttype:"CREATE",data:s},t=await d(r.REMOTESTORAGEURL,e);if(t.Error!==!0&&t.Data!==""&&t.Data!==null&&t.Data!==void 0)return!0}async function D(s){const e={owlbearid:l.player.id,requesttype:"UPDATE",data:JSON.stringify(s)},t=await d(r.REMOTESTORAGEURL,e);if(t.Error!==!0&&t.Data!==""&&t.Data!==null&&t.Data!==void 0)return!0}async function h(s){const e={owlbearid:l.player.id,requesttype:"DELETE",data:s},t=await d(r.REMOTESTORAGEURL,e);if(t.Data!==""&&t.Data!==null&&t.Data!==void 0)return!0}class p{isUserRegistered;dialogues=[];constructor(e){this.isUserRegistered=e}async migrateLocalToRemote(e){n.log("[Storage] Migrating",e.length,"local dialogues to remote storage");const t=e.map(a=>({...a,theatre_id:u()}));if(await c(JSON.stringify(t)))for(const a of e)this.deleteLocalDialogue(a.id)}loadLocalDialogues(){const e=localStorage.getItem(r.STORAGEKEY);return e?JSON.parse(e).map(t=>({...t,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt)})):[]}async loadRemoteDialogues(){const e=await g();return e&&Array.isArray(e)?(n.log("[Storage] Loaded",e.length,"dialogues from remote"),e.map(t=>({...JSON.parse(t.save_data),createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt)}))):[]}mergeDialogues(e,t){const i=new Map;return e.forEach(a=>{i.set(a.id,a)}),t.forEach(a=>{const o=i.get(a.id);(!o||new Date(a.updatedAt)>new Date(o.updatedAt))&&i.set(a.id,a)}),Array.from(i.values()).sort((a,o)=>new Date(o.updatedAt).getTime()-new Date(a.updatedAt).getTime())}saveLocalDialogues(e){localStorage.setItem(r.STORAGEKEY,JSON.stringify(e))}async saveRemoteDialogue(e){n.log("[Storage] Saving dialogue to remote:",e.id,e.title),e.theatre_id=e.id,await D(e)}deleteLocalDialogue(e){const i=this.loadLocalDialogues().filter(a=>a.id!==e);this.saveLocalDialogues(i)}async deleteRemoteDialogue(e){await h(e)}async loadDialogues(){if(this.isUserRegistered){const[e,t]=await Promise.all([Promise.resolve(this.loadLocalDialogues()),this.loadRemoteDialogues()]);this.dialogues=this.mergeDialogues(e,t),n.log("[Storage] Merged dialogues count:",this.dialogues.length),e.length>0&&await this.migrateLocalToRemote(e)}else this.dialogues=this.loadLocalDialogues(),n.log("[Storage] Loaded",this.dialogues.length,"local dialogues")}async saveDialogues(e){if(this.isUserRegistered){const t=this.dialogues.find(i=>i.id===e);t&&await this.saveRemoteDialogue(t)}else this.saveLocalDialogues(this.dialogues)}async deleteDialogue(e){const t=this.dialogues.find(i=>i.id===e);this.dialogues=this.dialogues.filter(i=>i.id!==e),this.isUserRegistered?t&&t.theatre_id&&this.deleteRemoteDialogue(t.theatre_id):this.saveLocalDialogues(this.dialogues)}}export{p as DialogueStorageManager};
